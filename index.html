<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smash Routes</title>
  
  <!-- External Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,800&display=swap" rel="stylesheet">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css" />
  <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
  
  <!-- Our CSS -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/clean-interface.css">
  <link rel="stylesheet" href="css/excel-history.css">
  <link rel="stylesheet" href="css/mobile-navigation.css">
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDQqCkBqmHRiX04Xtydb2v0IjxpssxzpQQ",
      authDomain: "smash-routes.firebaseapp.com",
      projectId: "smash-routes",
      storageBucket: "smash-routes.appspot.com",
      messagingSenderId: "972794327507",
      appId: "1:972794327507:web:1898851dc74ea32e58ff26",
      measurementId: "G-6LW1NP9XHG"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <!-- Auth UI -->
  <div id="subtle-login-bar" style="position:fixed;top:18px;right:24px;z-index:10001;">
    <button id="show-login-btn" class="tab-button">Sign In</button>
    <div id="user-info" style="display:none;">
      <span id="user-email" style="font-weight:600;"></span>
      <button id="excel-history-btn" style="margin-left:8px;padding:5px 8px;font-size:1.1rem;" title="Excel History">ğŸ“Š</button>
      <button id="logout-btn" style="margin-left:8px;padding:5px 14px;">Logout</button>
    </div>
  </div>
  
  <div id="firebaseui-auth-card" style="display:none;position:fixed;top:60px;right:24px;z-index:10002;">
    <div style="width:320px;padding:18px 14px 14px 14px;background:#fff;border-radius:14px;box-shadow:0 6px 32px rgba(44,62,80,0.18);border:1.5px solid #e6eaf2;">
      <div style="text-align:center;margin-bottom:10px;">
        <span style="font-size:1.1rem;font-weight:700;color:#1a2330;">Sign in</span>
      </div>
      <div id="firebaseui-auth-container"></div>
      <button id="close-login-btn" class="secondary-btn">Cancel</button>
    </div>
  </div>

  <!-- Main Application -->
  <div class="page-wrapper desktop-planning-mode">
    <div class="left-panel">
      <div class="container">
        <!-- Header -->
        <div class="header-area">
          <h1 style="display: flex; align-items: center; gap: 12px; font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 2.2rem; color: #1a2330; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            ğŸš— Smash Routes
          </h1>
          <a href="#" class="sign-in-link">Sign in</a>
        </div>

        <form id="routeForm">
          <!-- Tab Navigation -->
          <div class="tab-navigation">
            <button type="button" id="planRouteTab" class="tab-button active">Plan Route</button>
            <button type="button" id="manageFilesTab" class="tab-button">Manage Files</button>
          </div>

          <!-- Plan Route Tab -->
          <div id="planRouteContent" class="tab-content active">
            <!-- Action Buttons Section -->
            <div class="form-section" style="background: #f8f9fa; padding: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px;">
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button type="button" id="pasteAddressesBtn" class="secondary-btn" style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  ğŸ“‹ Paste Addresses
                </button>
                <button type="button" id="uploadFileBtn" class="secondary-btn" style="box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  ğŸ“ Upload File
                </button>
              </div>
            </div>
            
            <!-- Address Input Section -->
            <div class="form-section">
              <div style="margin-bottom: 16px;">
                <input type="text" id="manualStartAddress" class="clean-input required-field" placeholder="âœ“ Start Address (Required)" style="width: 100%; box-shadow: 0 2px 6px rgba(220, 53, 69, 0.15); border: 2px solid #ffc107; background: #fffbf0;">
              </div>
            </div>
            
            <div id="destinationFieldsContainer" class="form-section">
              <div id="destinationFields">
                <div class="destination-input-container" style="position: relative; margin-bottom: 12px;">
                  <input type="text" class="clean-input destination-input destination-field" placeholder="Destination 1" style="width: 100%; padding-right: 40px; box-shadow: 0 2px 4px rgba(0,0,0,0.06);">
                  <button type="button" class="clear-btn" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); box-shadow: 0 1px 3px rgba(0,0,0,0.1);">Ã—</button>
                </div>
              </div>
              <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button type="button" id="addDestinationBtn" class="add-destination-btn" style="box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                  + Add Destination
                </button>
                <button type="submit" class="primary-action-btn" style="box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                  ğŸš€ Get Optimized Route
                </button>
              </div>
            </div>
          </div>

          <!-- Manage Files Tab -->
          <div id="manageFilesContent" class="tab-content">
            <!-- Excel History Section -->
            <div id="excelHistorySection" class="form-section">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0; color: #333;">ğŸ“Š Excel Files</h3>
                <button type="button" id="deleteAllExcelBtn" class="secondary-btn" style="background: #dc3545; color: white;" title="Delete All Excel Files">ğŸ—‘ï¸ Delete All</button>
              </div>
              <div id="excelHistoryList" class="excel-history-list">
                <!-- Excel files will be populated here -->
              </div>
            </div>
          </div>

          <!-- Primary Action Button moved to inline with Add Destination button -->
        </form>
      </div>
    </div>
    
    <!-- Map Panel -->
    <div class="right-panel">
      <div id="map"></div>
      <div id="drawArrowOverlay" style="display:none;position:absolute;z-index:1000;pointer-events:none;"></div>
    </div>
  </div>

  <!-- Mobile Navigation Interface -->
  <div class="mobile-navigation-mode">
    <!-- Mobile Authentication Button (replacement for desktop auth) -->
    <button class="mobile-auth-button" id="mobileAuthButton" style="display: none;">
      ğŸ‘¤ Sign In
    </button>

    <!-- Mobile Settings Menu -->
    <div class="mobile-settings-menu" id="mobileSettingsMenu">
      <div class="mobile-settings-item" id="mobileAuthMenuItem">
        <span>ğŸ‘¤</span> <span id="mobileAuthText">Sign In</span>
      </div>
      <div class="mobile-settings-item" id="mobileViewDataItem">
        <span>ğŸ“Š</span> <span>View Data</span>
      </div>
      <div class="mobile-settings-item" id="mobileDesktopModeItem">
        <span>ğŸ–¥ï¸</span> <span>Desktop Mode</span>
      </div>
      <div class="mobile-settings-item" id="mobileHelpItem">
        <span>â“</span> <span>Help</span>
      </div>
    </div>

    <div class="mobile-nav-container">
      <!-- Navigation Header -->
      <div class="mobile-nav-header">
        <div class="mobile-nav-progress">
          <span id="mobileProgressText">DEMO MODE: Stop 3 of 12 â€¢ 47% Complete</span>
        </div>
        <div class="mobile-nav-progress-bar">
          <div class="mobile-nav-progress-fill" id="mobileProgressFill" style="width: 47%"></div>
        </div>
      </div>

      <!-- Current Destination Card -->
      <div class="mobile-destination-card">
        <div class="mobile-destination-header">
          ğŸ“ CURRENT DESTINATION
        </div>
        <div class="mobile-destination-content">
          <div class="mobile-destination-address" id="mobileDestinationAddress">
            123 Oak Street, Houston TX 77001
          </div>
          <div class="mobile-destination-details" id="mobileDestinationOwner">
            ğŸ‘¤ John & Mary Smith
          </div>
          <div class="mobile-destination-details" id="mobileDestinationDate">
            ğŸ“… Auction: Feb 15, 2025
          </div>
          <div class="mobile-destination-distance" id="mobileDestinationDistance">
            ğŸ—ºï¸ 2.3 miles â€¢ â±ï¸ 8 min drive
          </div>
        </div>
      </div>

      <!-- Navigation Controls -->
      <div class="mobile-nav-controls">
        <!-- Primary Navigation Controls -->
        <div class="mobile-nav-primary-controls">
          <button class="mobile-nav-btn mobile-nav-btn-previous" id="mobilePreviousBtn">
            <div style="text-align: center;">
              <div style="font-size: 18px;">â—€</div>
              <div style="font-size: 12px; margin-top: 2px;">PREVIOUS</div>
            </div>
          </button>
          <button class="mobile-nav-btn mobile-nav-btn-checkin" id="mobileCheckInBtn">
            <div style="text-align: center;">
              <div style="font-size: 18px;">âœ“</div>
              <div style="font-size: 12px; margin-top: 2px;">CHECK IN</div>
            </div>
          </button>
          <button class="mobile-nav-btn mobile-nav-btn-next" id="mobileNextBtn">
            <div style="text-align: center;">
              <div style="font-size: 18px;">â–¶</div>
              <div style="font-size: 12px; margin-top: 2px;">NEXT</div>
            </div>
          </button>
        </div>

        <!-- Primary Navigate Button -->
        <button class="mobile-navigate-btn" id="mobileNavigateBtn">
          ğŸ—ºï¸ NAVIGATE NOW
        </button>

        <!-- Secondary Controls -->
        <div class="mobile-nav-secondary-controls">
          <button class="mobile-secondary-btn" id="mobileNotesBtn">
            ğŸ“ Add Notes
          </button>
          <button class="mobile-secondary-btn" id="mobileSkipBtn">
            â­ï¸ Skip Stop
          </button>
          <button class="mobile-secondary-btn" id="mobileMenuBtn">
            âš™ï¸ Settings
          </button>
        </div>
      </div>

      <!-- Map Container -->
      <div class="mobile-map-container">
        <div id="mobileMap"></div>
        
        <!-- Map Controls -->
        <div class="mobile-map-controls">
          <button class="mobile-map-control-btn" id="mobileCurrentLocationBtn" title="Center on Current Location">
            ğŸ“
          </button>
          <button class="mobile-map-control-btn" id="mobileFitRouteBtn" title="Show Full Route">
            ğŸ—ºï¸
          </button>
        </div>
      </div>
    </div>

    <!-- Route Overview Toggle Button -->
    <button class="mobile-route-toggle" id="mobileRouteToggle">
      ğŸ“‹ Route
    </button>

    <!-- Route Overview Panel (Slide-out) -->
    <div class="mobile-route-overview" id="mobileRouteOverview">
      <div class="mobile-route-panel">
        <div class="mobile-route-header">
          ğŸ“‹ Route Overview
          <button class="mobile-route-close" id="mobileRouteClose">Ã—</button>
        </div>
        <div class="mobile-route-list" id="mobileRouteList">
          <!-- Route items will be populated by JavaScript -->
          <div class="mobile-route-item">
            <div class="mobile-route-number completed">âœ“</div>
            <div class="mobile-route-address">456 Pine Street<br><small>Completed 2:30 PM</small></div>
          </div>
          <div class="mobile-route-item">
            <div class="mobile-route-number completed">âœ“</div>
            <div class="mobile-route-address">789 Elm Avenue<br><small>Completed 3:15 PM</small></div>
          </div>
          <div class="mobile-route-item">
            <div class="mobile-route-number current">3</div>
            <div class="mobile-route-address">123 Oak Street<br><small>Current destination</small></div>
          </div>
          <div class="mobile-route-item">
            <div class="mobile-route-number next">4</div>
            <div class="mobile-route-address">321 Maple Drive<br><small>Next stop</small></div>
          </div>
          <div class="mobile-route-item">
            <div class="mobile-route-number pending">5</div>
            <div class="mobile-route-address">654 Cedar Lane<br><small>Pending</small></div>
          </div>
        </div>
      </div>
    </div>

    <!-- GPS Status Indicator -->
    <div class="mobile-gps-status" id="mobileGpsStatus">
      ğŸ“ GPS Active
    </div>
  </div>

  <!-- Global Geocoding Progress Indicator -->
  <div id="globalGeocodingProgress" class="global-progress-overlay">
    <div class="global-progress-content">
      <div class="global-progress-header">
        <span class="global-progress-title">ğŸŒ Geocoding Addresses</span>
        <span class="global-progress-stats" id="globalProgressStats">0/0 (0%)</span>
      </div>
      <div class="global-progress-bar-wrapper">
        <div class="global-progress-bar" id="globalProgressBar"></div>
      </div>
      <div class="global-progress-details">
        <span id="globalProgressStatus">Preparing addresses...</span>
        <span class="global-progress-eta" id="globalProgressEta"></span>
      </div>
    </div>
  </div>

  <!-- Hidden Legacy Elements for JavaScript Compatibility -->
  <div class="legacy-hidden">
    <div id="messageArea"></div>
    <div id="debugArea"></div>
    <div id="googleSheetError"></div>
    <div id="drawTooltip"></div>
  </div>

  <!-- Excel History Slide-out Panels -->
  <div id="excelHistoryOverlay" class="excel-history-overlay">
    <div id="excelHistoryPanel" class="excel-history-panel">
      <div class="panel-header">
        <h3>ğŸ“Š Excel History</h3>
        <div style="display: flex; gap: 8px; align-items: center;">
          <button id="closeExcelHistoryBtn" class="close-btn">Ã—</button>
        </div>
      </div>
      <div class="panel-content">
        <div id="excelHistoryList" class="excel-history-list">
          <!-- Excel files will be populated here -->
        </div>
      </div>
    </div>
    
    <div id="excelDataPanel" class="excel-data-panel">
      <div class="panel-header">
        <h3 id="excelDataTitle">ğŸ“‹ Excel Data</h3>
        <button id="closeExcelDataBtn" class="close-btn">Ã—</button>
      </div>
      <div class="panel-content">
        <div id="excelDataContent" class="excel-data-content">
          <!-- Full data view will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Paste Addresses Modal -->
  <div id="pasteAddressesModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ“‹ Paste Multiple Addresses</h3>
        <button type="button" id="closePasteModalBtn" class="close-btn">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px; color: #666; font-size: 0.9rem;">Paste your addresses below, one per line:</p>
        <textarea id="pasteAddressesModalTextarea" class="clean-input" placeholder="123 Main St, City, State&#10;456 Oak Ave, City, State&#10;789 Pine Rd, City, State" rows="8"></textarea>
        <div style="display: flex; gap: 12px; margin-top: 16px; justify-content: flex-end;">
          <button type="button" id="cancelPasteModalBtn" class="secondary-btn">Cancel</button>
          <button type="button" id="confirmPasteModalBtn" class="primary-action-btn">Add All Addresses</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload File Modal -->
  <div id="uploadFileModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="uploadModalTitle">ğŸ“ Upload Excel/CSV File</h3>
        <button type="button" id="closeUploadModalBtn" class="close-btn">Ã—</button>
      </div>
      <div class="modal-body">
        <!-- Step 1: File Selection -->
        <div id="uploadStep1" class="upload-step">
          <div style="margin-bottom: 20px;">
            <label class="section-label" style="margin-bottom: 8px; display: block;">Choose Excel/CSV File</label>
            <input type="file" id="excelFileModal" class="clean-input" accept=".xlsx,.xls,.csv" />
          </div>
          
          <div style="margin-bottom: 20px;">
            <label class="section-label" style="margin-bottom: 8px; display: block;">Or Google Sheets URL</label>
            <input type="text" id="googleSheetUrlModal" class="clean-input" placeholder="https://docs.google.com/spreadsheets/d/...">
            <button type="button" id="loadGoogleSheetModalBtn" class="secondary-btn" style="margin-top: 8px;">Load from URL</button>
            <div id="googleSheetModalError" style="display: none; margin-top: 8px; padding: 8px; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c00; font-size: 0.9rem;"></div>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" id="cancelUploadModalBtn" class="secondary-btn">Cancel</button>
          </div>
        </div>

        <!-- Step 2: Column Mapping -->
        <div id="uploadStep2" class="upload-step" style="display: none;">
          <div style="margin-bottom: 16px; padding: 12px; background: #fffbe7; border: 1px solid #ffe082; border-radius: 6px;">
            <p style="margin: 0; color: #8a6914; font-weight: 500;">ğŸ“‹ Select the columns that contain your data:</p>
          </div>
          
          <div id="columnMappingContent" style="margin-bottom: 20px;">
            <!-- Column selection dropdowns will be inserted here -->
          </div>
          
          <!-- Progress Container -->
          <div id="geocodingProgress" class="progress-container">
            <div class="progress-header">
              <span class="progress-title">ğŸŒ Geocoding Addresses</span>
              <span class="progress-stats" id="progressStats">0/0 (0%)</span>
            </div>
            <div class="progress-bar-wrapper">
              <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-details">
              <span id="progressStatus">Preparing addresses...</span>
              <span class="progress-eta" id="progressEta"></span>
            </div>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: space-between;">
            <button type="button" id="backToUploadBtn" class="secondary-btn">â† Back</button>
            <div style="display: flex; gap: 8px;">
              <button type="button" id="clearPresetModalBtn" class="secondary-btn">Clear Preset</button>
              <button type="button" id="confirmColumnMappingBtn" class="primary-action-btn">Confirm Mapping</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Overlay -->
  <div id="notesOverlay" class="notes-overlay">
    <div class="notes-header">
      <h3 id="notesAddressTitle">Add Note</h3>
      <button id="closeNotesBtn" class="close-notes-btn">Ã—</button>
    </div>
    <div class="notes-content">
      <div class="notes-address">
        <strong>Address:</strong>
        <span id="notesAddressText"></span>
      </div>
      <div class="notes-input-section">
        <label for="noteTextarea">Note:</label>
        <textarea id="noteTextarea" placeholder="Add your note here..." rows="8"></textarea>
        <div class="notes-meta">
          <span id="noteTimestamp"></span>
          <span id="noteCharCount">0/500</span>
        </div>
      </div>
      <div class="visit-tracking-section">
        <div class="visit-info">
          <div id="visitStats" class="visit-stats"></div>
          <button id="markVisitedBtn" class="mark-visited-btn">ğŸ“ Visited Today</button>
        </div>
        <div id="visitHistory" class="visit-history" style="display: none;">
          <h4>Visit History:</h4>
          <ul id="visitHistoryList"></ul>
        </div>
      </div>
      
      <div class="notes-actions">
        <button id="saveNoteBtn" class="primary-action-btn">Save Note</button>
        <button id="deleteNoteBtn" class="secondary-btn" style="background: #dc3545; color: white;">Delete Note</button>
        <button id="cancelNoteBtn" class="secondary-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Our JavaScript Modules - Load in dependency order -->
  <script src="js/firebase-utils.js"></script>
  <script src="js/firebase-auth.js"></script>
  <script src="js/app.js"></script>
  <script src="js/tabs.js"></script>
  <script src="js/address-manager.js"></script>
  <script src="js/route-optimizer.js"></script>
  <script src="js/excel-handler.js"></script>
  <script src="js/map-core.js"></script>
  <script src="js/map-drawing.js"></script>
  <script src="js/map-markers.js"></script>
  <script src="js/map-handler.js"></script>
  <script src="js/visit-display.js"></script>
  <script src="js/visit-manager.js"></script>
  <script src="js/address-list-renderer.js"></script>
  <script src="js/notes-manager.js"></script>
  <script src="js/excel-data-table.js"></script>
  <script src="js/excel-operations.js"></script>
  <script src="js/excel-history.js"></script>
  <script src="js/mobile-navigation.js"></script>
</body>
</html>
